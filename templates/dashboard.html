<!doctype html>
{% load static %}
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <style>
    :root{
      --bg1: #5dade2;
      --bg2: #85c1e9;
      --panel-bg: rgba(255,255,255,0.08);
      --card-bg: rgba(255,255,255,0.12);
      --accent: #21618c;
      --accent-dark: #1b4f72;
      --glass-blur: 10px;
      --radius: 12px;
      --text: #eef6fb;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:stretch;
      gap:24px;
      padding:28px;
    }

    /* --- Sidebar --- */
    .sidebar{
      width:280px;
      max-width:34%;
      background:var(--panel-bg);
      backdrop-filter: blur(var(--glass-blur));
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.18);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(255,255,255,0.04);
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:10px;
      background:linear-gradient(180deg,var(--accent),var(--accent-dark));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:white;
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:0;font-size:12px;color:rgba(238,246,251,0.8)}

    .profile{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:10px;
      background:var(--card-bg);
    }
    .avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#fff4,#ffffff11);display:flex;align-items:center;justify-content:center;color:#06314a;font-weight:700}
    .profile .meta{font-size:14px}
    .profile .meta small{display:block;color:rgba(238,246,251,0.75); font-size:12px}

    .menu{display:flex;flex-direction:column; gap:6px; padding-top:8px}
    .menu button{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:10px;
      border:none;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      text-align:left;
      font-size:15px;
    }
    .menu button .icon{width:18px;height:18px; opacity:0.95}
    .menu button:hover{background:rgba(255,255,255,0.03)}
    .menu button.active{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}

    .menu .sep{height:1px;background:rgba(255,255,255,0.03); margin:8px 0; border-radius:4px}

    /* --- Main panel --- */
    .main{
      flex:1; min-width:0; display:flex; flex-direction:column; gap:18px;
    }
    .topbar{
      height:66px;
      border-radius:var(--radius);
      padding:12px 18px;
      background:var(--panel-bg);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow:0 8px 24px rgba(0,0,0,0.12);
    }
    .search{flex:0 0 420px; display:flex; gap:8px; align-items:center}
    .search input{flex:1;padding:10px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:var(--text)}
    .search button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent); color:white; cursor:pointer}

    /* Grid content: left wide + right side */
    .content{
      flex:1;
      display:grid;
      grid-template-columns: repeat(12,1fr);
      gap:18px;
      align-items:start;
    }

    /* Left column inside main area (wide card area) */
    .card{grid-column: span 8; background:var(--card-bg); padding:18px; border-radius:12px; min-height:220px}
    .side-card{grid-column: span 4; background:var(--card-bg); padding:18px; border-radius:12px; min-height:220px}

    /* If you want a single full-width card */
    .card.full{grid-column: 1 / -1}

    /* headings */
    .card h3, .side-card h3{margin:0 0 12px 0}
    .placeholder{color:rgba(238,246,251,0.75); font-size:14px}

    /* pages */
    .page{display:none}
    .page.active{display:block}

    /* weather widget inside side-card or inside card.full */
    .weather {display:flex; gap:12px; align-items:center}
    .weather .temp{font-size:34px; font-weight:700}
    .weather small{display:block;color:rgba(238,246,251,0.8)}

    /* weather controls (region/city selects) */
    .weather-controls{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    @media (min-width:900px){
      .weather-controls{flex-direction:row}
    }
    .select{
      width:100%;
      padding:10px 12px;
      background:rgba(255,255,255,0.03);
      border-radius:10px;
      border:none;
      color:var(--text);
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
    }

    /* if placed inside side-card or card, icon on right */
    .weather-box{
      display:flex;
      align-items:center;
      gap:16px;
      background:rgba(255,255,255,0.02);
      padding:12px;
      border-radius:10px;
    }

    /* small visual tweaks */
    .temp { font-size:40px; font-weight:800; line-height:1; }
    .weather-icon img{width:48px;height:48px}
    .weather .desc{font-size:13px; opacity:0.9}

    /* "Temperature feels like" */
    .feel { display:block; margin-top:12px; color:rgba(238,246,251,0.82) }

    /* Quick buttons in sidebar area */
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:9px;color:var(--text);cursor:pointer}
    .quick-buttons{display:flex;flex-direction:column;gap:8px;margin-top:8px}

    /* small niceties for cards in main section */
    .stat-box{flex:1; min-width:150px; background:rgba(255,255,255,0.03); padding:12px; border-radius:10px}
    .stat-box .num{font-size:20px; margin-top:6px}

    /* form input styling used in profile */
    .input{
      width:100%;
      margin-top:8px;
      padding:10px;
      border-radius:8px;
      border:none;
      background:rgba(255,255,255,0.03);
      color:var(--text);
    }

    /* responsive */
    @media (max-width:900px){
      body{padding:18px}
      .sidebar{display:none}
      .card{grid-column:1/-1}
      .side-card{grid-column:1/-1}
      .search{flex:1}
      .weather-controls{flex-direction:column}
    }

    /* tiny helpers */
    .small-muted{font-size:13px; color:rgba(238,246,251,0.75)}
    .center{display:flex; align-items:center; justify-content:center}

    .beautiful-btn {
        background: linear-gradient(135deg, #4f46e5, #3b82f6);
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .beautiful-btn:hover {
        background: linear-gradient(135deg, #6366f1, #60a5fa);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }

    .beautiful-btn:active {
        transform: scale(0.96);
    }


  </style>
</head>
<body data-regions-url="{% static 'json/regions_lot.json' %}">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">DB</div>
      <div>
        <h1>Meniń Dashboard</h1>
        <p>Admin panel</p>
      </div>
    </div>

    <div class="profile">
      <div class="avatar">B</div>
      <div class="meta">
        <strong>Babur</strong>
        <small>Admin • babur@example.com</small>
      </div>
    </div>

    <nav class="menu" aria-label="Main menu">
      <button class="active" data-page="home"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg> Bas Bólim</button>
      <button data-page="profile"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM3 20a9 9 0 0 1 18 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg> Profil</button>
      <button data-page="weather"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 16.58A5.5 5.5 0 0 0 14.5 8h-.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 16h9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Hawa-rayı</button>
      <div class="sep"></div>
<!--      <button data-page="users"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M23 19v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg> Foydalanuvchilar</button>-->
      <button data-page="settings"><svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82A1.65 1.65 0 0 0 3 12c0-.56-.23-1.09-.63-1.49A2 2 0 1 1 4.4 7.68 1.65 1.65 0 0 0 4.07 5.86 2 2 0 1 1 6.9 3.03 1.65 1.65 0 0 0 8.72 3.36c.56 0 1.09.23 1.49.63A2 2 0 0 1 12 4.6c.56 0 1.09.23 1.49.63A1.65 1.65 0 0 0 15 3.36 2 2 0 1 1 17.83 5.86c.23.7.6 1.33 1.17 1.8A2 2 0 1 1 20.37 9.5c.4.4.63.93.63 1.5 0 .4-.14.78-.37 1.08z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/></svg> Sazlamalar</button>
    </nav>

    <div style="margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button class="btn-ghost" id="logout" type="submit">Shıǵıw</button>
      </form>
      <small style="opacity:0.8">v1.0</small>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:12px">
        <h2 style="margin:0">Bas bólimi</h2>
        <small style="opacity:0.8">Dashboard</small>
      </div>

<!--      <div class="search">-->
<!--        <input placeholder="Qıdırıw..." />-->
<!--        <button>Qıdırıw</button>-->
<!--      </div>-->
    </div>

    <div class="content">
      <section class="card full">
        <!-- HOME page -->
        <div id="page-home" class="page active">
          <h3>Dashboardińızǵa Xosh keldińiz, {{ request.user.first_name }} {{ request.user.last_name }} !</h3>
          <h3 class="placeholder">Bugin siz ushın bárshe malıwmatlar — tártipli, qolay hám bir jerde jámlengen.
Shaxsiy profilińizdi ózgeris kiritiń, kerekli xızmetlerden paydalanıń hám bárshe xızmetlerdi ańsat basqarıń.
Sizge qolaylı hám paydalı is alıp barıwıńız ushın bárshe imkaniyatlar usı jerde.</h3>
          <!-- stats boxes -->
        </div>


        <!-- PROFILE page -->
            <div id="page-profile" class="page">
              <h3>Profil</h3>

              <form id="profile-form" style="margin-top:16px; display:flex; flex-direction:column; gap:12px">

                <div>
                  <label>Login</label>
                  <input id="prof-username" class="input" type="text" readonly>
                </div>

                <div>
                  <label>Email pochta</label>
                  <input id="prof-email" class="input" type="email">
                </div>

                <div>
                  <label>Familiya</label>
                  <input id="prof-firstname" class="input" type="text">
                </div>

                <div>
                  <label>Atı</label>
                  <input id="prof-lastname" class="input" type="text">
                </div>

                <div>
                  <label>Respublika yamasa vilayat</label>
                  <select id="prof-region" class="select"></select>
                </div>

                <div>
                  <label>Qala yamasa rayon</label>
                  <select id="prof-city" class="select"></select>
                </div>

                <div>
                  <label>Parol (Ózgertirejaq bolsańız)</label>
                  <input id="prof-password" class="input" type="password" placeholder="Taza parol kiritiń">
                </div>

                  <button type="submit" class="beautiful-btn">Saqlaw</button>
              </form>

              <p id="prof-message" style="margin-top:10px; color:green; font-weight:bold; display:none"></p>
            </div>




        <!-- ===== Hawa rayı bólimi ===== -->
        <div id="page-weather" class="page">
          <h3>Hawa rayı</h3>

          <!-- Viloyat/Shahar select -->
          <div class="weather-controls" style="margin-bottom:12px;">
            <select id="region-select" class="select"></select>
            <select id="city-select" class="select"></select>
          </div>

          <!-- Weather box -->
          <div class="weather weather-box">
            <div>
              <!-- Temp (JS: #page-weather .temp) -->
              <div class="temp">+26<span style="font-size:16px">°C</span></div>
              <small id="weather-location">Bugun</small>
            </div>

            <!-- Right side (JS: #page-weather > .weather > div:nth-child(2)) -->
            <div style="margin-left:auto; text-align:right">
              <img id="weather-icon" src="" alt="" style="width:48px;height:48px;display:none">
              <div id="weather-desc" style="font-size:13px; opacity:0.85">Bulıtlı</div>
            </div>
          </div>

        </div>
        <!-- ===== end page-weather ===== -->

      </section>
    </div>


  </main>

  <script>
  // get regions_lot.json url from template (set in <body data-regions-url="...">)
  const REGIONS_JSON_URL = document.body.getAttribute('data-regions-url');

  const regionSelect = document.getElementById('region-select');
  const citySelect = document.getElementById('city-select');

  fetch(REGIONS_JSON_URL)
    .then(res => {
      if(!res.ok) throw new Error('Vilayat yamasa rayon json fayli juklenbedi: ' + res.status);
      return res.json();
    })
    .then(data => {
      regionSelect.innerHTML = '<option value="">Jasap turǵan Respublika yamasa vilayat saylań</option>';
      citySelect.innerHTML = '<option value="">Jasap turǵan qala yamasa rayondı saylań</option>';
      Object.keys(data).forEach(region => {
        const opt = document.createElement('option');
        opt.value = region;
        opt.textContent = region;
        regionSelect.appendChild(opt);
      });

      regionSelect.addEventListener('change', () => {
        const region = regionSelect.value;
        citySelect.innerHTML = '<option value="">Jasap turǵan qala yamasa rayondi saylań</option>';
        if(!region) { citySelect.disabled = true; return; }
        citySelect.disabled = false;
        const cities = data[region] || [];
        cities.forEach(c => {
          const o = document.createElement('option');
          // store lat/lon in data- attributes as JSON string
          o.value = JSON.stringify({name: c.name, lat: c.lat, lon: c.lon});
          o.textContent = c.name;
          citySelect.appendChild(o);
        });
      });

      citySelect.disabled = true;
    })
    .catch(err => {
      console.error(err);
      alert('Vilayat yamasa rayon fayli juklenbedi — admin menen baylanısıń!.');
    });

  async function fetchWeatherByLatLon(lat, lon){
    try {
      const resp = await fetch(`/weather?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&units=metric`);
      if(!resp.ok){
        const err = await resp.json().catch(()=>({detail:'Qátelik'}));
        console.error('Weather API error', err);
        alert('Hawa rayı malıwmarları alınbadı: ' + (err.error?.message || err.detail || JSON.stringify(err)));
        return;
      }
      const payload = await resp.json();
      const data = payload.data || (payload); // payload may wrap
      const weather = payload.data || payload.data || payload.data || payload; // safe pick
      // actual data object with 'main'
      const actual = (payload.data && payload.data.main) ? payload.data : (payload.data || payload);
      // update UI using your previously defined showWeatherFromJSON or inline:
      showWeatherFromJSON(actual);
    } catch(e){
      console.error(e);
      alert('Tarmaq qáteligi kelip shıqtı: Hawa rayı alınbadı.');
    }
  }


  // city select change handler
  citySelect.addEventListener('change', (e) => {
    const v = e.target.value;
    if(!v) return;
    const obj = JSON.parse(v);
    fetchWeatherByLatLon(obj.lat, obj.lon);
  });

  // reuse your earlier showWeatherFromJSON function (adapted to your HTML)
  function showWeatherFromJSON(json){
    if(!json || !json.main) return;
    const tempEl = document.querySelector('#page-weather .temp');
    const rightDiv = document.querySelector('#page-weather > .weather > div:nth-child(2)');
    const t = Math.round(json.main.temp);
    if(tempEl) tempEl.innerHTML = (t > 0 ? '+'+t : t) + '<span style="font-size:16px">°C</span>';

    const desc = (json.weather && json.weather[0] && json.weather[0].description) ? json.weather[0].description : '';
    if(rightDiv){
      const icon = json.weather[0] && json.weather[0].icon ? json.weather[0].icon : null;
      if(icon){
        const iconUrl = `https://openweathermap.org/img/wn/${icon}@2x.png`;
        rightDiv.innerHTML = `<img src="${iconUrl}" alt="${desc}" style="width:48px;height:48px"><div style="font-size:13px; opacity:0.85">${desc}</div>`;
      } else {
        rightDiv.innerHTML = `<div style="font-size:13px; opacity:0.85">${desc}</div>`;
      }
    }

    const feels = json.main ? json.main.feels_like : null;
    const feelsEl = document.querySelector('#page-weather small');
    if(feelsEl && typeof feels === 'number') feelsEl.innerHTML = "Keshki hawa rayı <strong>" + (feels > 0 ? '+'+Math.round(feels) : Math.round(feels)) + "°C</strong>";
  }
</script>

   <script>
document.addEventListener("DOMContentLoaded", function() {

    // 1️⃣ Profil malıwmatlardı juklew
    fetch("/api/profile/")
        .then(res => {
            if(!res.ok) throw new Error("Profil malıwmatları alınbadı");
            return res.json();
        })
        .then(data => {
            document.getElementById("prof-username").value = data.username || "";
            document.getElementById("prof-email").value = data.email || "";
            document.getElementById("prof-firstname").value = data.first_name || "";
            document.getElementById("prof-lastname").value = data.last_name || "";

            // agar region oldin bazada saqlangan bo'lsa, usha regionni tanlab qo'yamiz
            // egerde vilayat aldın bazada saqlanǵan bolsa, sol vilayat saylap qayamiz
            document.getElementById("prof-region").value = data.region || "";
            // loadCities Ishinde eger vilayat bolsa, selectedCity arqalı saylanǵan qalanı belgileymiz
            loadCities(data.region || "", data.city || "");
        })
        .catch(err => {
            console.error("Profil fetch qáteligi:", err);
        });

    // Vilayat json menen juklew hám sorawlardı tolıqtiriw
    let REGIONS_DATA = null; // cache qil
    fetch("/static/json/regions.json")
        .then(res => {
            if(!res.ok) throw new Error("Vilayat JSON faylı alınbadı: " + res.status);
            return res.json();
        })
        .then(regions => {
            REGIONS_DATA = regions; // cache
            const regionSel = document.getElementById("prof-region");
            regionSel.innerHTML = '<option value="">Jasap turǵan Respublika yamasa vilayatdı saylań</option>';

            Object.keys(regions).forEach(region => {
                const opt = document.createElement("option");
                opt.value = region;
                opt.textContent = region;
                regionSel.appendChild(opt);
            });

            // Eger paydalanıwshı vilayatdı keyin ózgeris kiritse, rayonlardı jańalamız
            regionSel.addEventListener("change", function() {
                loadCities(this.value);
            });
        })
        .catch(err => {
            console.error("Regions fetch xatosi:", err);
            // Paydalanıwshıǵa xabar beriw kerek
        });

    // Qalay yamasa rayondı - json farmatında bolıw, egerde element string bolsa yamasa object bolsa islew kerek
    function loadCities(region, selectedCity = "") {
        const citySel = document.getElementById("prof-city");
        citySel.innerHTML = '<option value="">Qala yamasa Rayon</option>';
        citySel.disabled = true;

        if(!region) return;

        // egerde data cashe bolsa onda alamız, joq bolsa fetch qılamız
        const proceedWith = (all) => {
            const cities = all[region];
            if(!Array.isArray(cities) || cities.length === 0) {
                citySel.disabled = true;
                return;
            }

            cities.forEach(c => {
                const opt = document.createElement("option");

                // c — string misol: "Olmazor"
                if (typeof c === "string") {
                    opt.value = c;           // value ge atı
                    opt.textContent = c;
                }
                // c — object misol: {name: "Olmazor", lat: ..., lon: ...}
                else if (typeof c === "object" && c !== null) {
                    const name = c.name || c.title || String(c);
                    // egerde keyinshelik lat/lot kerek bolsa nátejeni, json menen saqlap qoyamiz
                    if (typeof c.lat !== "undefined" && typeof c.lon !== "undefined") {
                        opt.value = JSON.stringify({name: name, lat: c.lat, lon: c.lon});
                    } else {
                        opt.value = name;
                    }
                    opt.textContent = name;
                } else {
                    // fallback
                    opt.value = String(c);
                    opt.textContent = String(c);
                }

                citySel.appendChild(opt);
            });

            citySel.disabled = false;

            // egerde selectedCity berilgen bolsa, onda saylap qoyamiz
            if (selectedCity) {
                // selectedCity bazada string kórinisinde saqlanǵan boliwi mumkin
                // sonińushın aldın tuwrıdan - tuwrı teńlestiremiz
                // eger option.value JSON.stringify({name: ..}) bolsa, biz opt.value ishindegi jsondi tekseremiz
                for (let i = 0; i < citySel.options.length; i++) {
                    const val = citySel.options[i].value;
                    // eger val json string bolsa hám onda name tekseriw kerek
                    try {
                        const parsed = JSON.parse(val);
                        if (parsed && parsed.name && parsed.name === selectedCity) {
                            citySel.selectedIndex = i;
                            return;
                        }
                    } catch(e) {
                        // not JSON — oddiy string
                        if (val === selectedCity) {
                            citySel.selectedIndex = i;
                            return;
                        }
                    }
                }
            }
        };

        if (REGIONS_DATA) {
            proceedWith(REGIONS_DATA);
        } else {
            //egerde cash bolsa fetsh qılamız
            fetch("/static/json/regions.json")
                .then(res => res.json())
                .then(all => {
                    REGIONS_DATA = all;
                    proceedWith(all);
                })
                .catch(err => {
                    console.error("Vilayat json faylı qáteligi (loadCities ishinde):", err);
                });
        }
    }

    // FORM jaratamız
    document.getElementById("profile-form").addEventListener("submit", function(e) {
        e.preventDefault();

        const payload = {
            email: document.getElementById("prof-email").value,
            first_name: document.getElementById("prof-firstname").value,
            last_name: document.getElementById("prof-lastname").value,
            region: document.getElementById("prof-region").value,
            city: document.getElementById("prof-city").value,
            password: document.getElementById("prof-password").value
        };

        fetch("/api/profile/update/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if(!res.ok) return res.json().then(j => Promise.reject(j));
            return res.json();
        })
        .then(data => {
            const msg = document.getElementById("prof-message");
            msg.style.display = "block";
            msg.style.color = "green";
            msg.textContent = data.message || "Profil saqlandı";
        })
        .catch(err => {
            const msg = document.getElementById("prof-message");
            msg.style.display = "block";
            msg.style.color = "red";
            msg.textContent = err.message || (err.detail || "Saqlawda qáteligi");
            console.error("Profil update qáteligi:", err);
        });
    });

    // CSRF oliw ushın funksiyası
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let c of cookies) {
                c = c.trim();
                if (c.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(c.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

});
</script>




  <script>
    // Menu switching logic
    const buttons = document.querySelectorAll('.menu button');
    const pages = document.querySelectorAll('.page');

    function showPage(id){
      pages.forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + id);
      if(el) el.classList.add('active');
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const page = btn.getAttribute('data-page');
        // update topbar title
        document.querySelector('.topbar h2').textContent = btn.textContent.trim();
        showPage(page);
      });
    });

    // initial show
    showPage('home');



    // Logout: tokenlerdi tazalaw hám serverge POST jiberiw, keyin toliq jiberiw
  (function(){
    const logoutBtn = document.getElementById('logout');
    if(!logoutBtn) return;
    const logoutForm = logoutBtn.closest('form');

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    logoutBtn.addEventListener('click', function(e){
      e.preventDefault();

      // Paydalanıwshı tárepden saqlanǵan token malıwmatlardı óshiriw
      try {
        localStorage.removeItem('access');
        localStorage.removeItem('refresh');
        sessionStorage.removeItem('access');
        sessionStorage.removeItem('refresh');
        // egerde putin localStorage tazalanǵan bolsa localStorage.clear(); boladi
      } catch(err){
        console.warn('Local storage clear qáteligi:', err);
      }

      // serverge POST jazamız (CSRF menen) - server  logout view di shaqıradı hám sessiyanı tamamlaydı
      // eger  /logout/ url basqa bolsa form.action avtomat isleydi (form HTML ge berilgende)
      const action = (logoutForm && logoutForm.action) ? logoutForm.action : '/logout/';

      fetch(action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Accept': 'application/json'
        },
        // body intentionally empty because form has CSRF cookie; some backends accept empty POST
      })
      .then(response => {
        // hár qanday juwapta brauzerdi login yamasa úy betine ya'naltiramiz
        // Eger server JSON arqalı redirect xabar beretuǵın bolsa, onı isley alamız
        try {
          // qattı redirect: eger server Ílaycation baser menen redirect qılsa, sholıwr avtomatikalıq islemeydi
          // sol sebepli biz óz basımshalıq menen tiykarǵı betke ya'naltiramiz
          window.location.href = '/'; // Bulmandı qáleseńiz login betine ózgertiriń
        } catch(e) {
          // Túsiwback: eger Fetch áwmetsiz bolsa, forma. tapsırıw arqalı POST etemiz
          if (logoutForm) logoutForm.submit();
          else window.location.href = '/';
        }
      })
      .catch(err => {
        console.warn('Logout fetch xatosi:', err);
        // fallback: normal form submit etıń
        if (logoutForm) logoutForm.submit();
        else window.location.href = '/';
      });
    });
  })();
  </script>
</body>
</html>
